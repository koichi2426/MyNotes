# Excel マクロ - 自動化とVBA入門

Excel で繰り返しの作業を自動化する VBA（Visual Basic for Applications）マクロの使い方

## Excel マクロとは

Excel マクロは、**Excel の操作を自動的に実行するプログラム**です。VBA（Visual Basic for Applications）という言語で書かれており、複雑な作業や繰り返しの処理を効率化することができます。

### マクロの用途

```
✅ マクロが活躍する場面

├─ データ入力の自動化
│  └─ 手作業での入力を自動処理
├─ 複数のシートへの一括処理
│  └─ 同じ操作を複数のシートに自動実行
├─ 定期的なレポート作成
│  └─ 毎月・毎週のレポート自動生成
├─ データの自動整形・クリーニング
│  └─ 不要なデータ削除、形式統一
├─ 別のアプリケーションとの連携
│  └─ Word、Outlook、PowerPoint との自動連携
└─ 複雑な計算結果の整理
   └─ 複数条件での集計・分析
```

### マクロの利点

```
時間短縮：
└─ 手作業で 1 時間かかる作業が数秒で完了

ヒューマンエラー削減：
└─ 人的ミスを排除し、確実な処理を実現

効率化：
└─ 社員の時間をより重要な業務に割当可能

再現性：
└─ 同じ処理を何度でも確実に実行
```

## Excel マクロの有効化

### Step 1: マクロのセキュリティ設定を確認

Excel でマクロを使用するには、セキュリティ設定を調整する必要があります。

**Windows版 Excel の手順：**

1. **ファイル** → **オプション** をクリック
2. **セキュリティセンター** → **セキュリティセンターの設定** をクリック
3. **マクロの設定** を選択
4. 以下から選択：
   - **すべてのマクロを有効にする**（開発時推奨）
   - **警告を表示してすべてのマクロを無効にする**（通常推奨）
   - **デジタル署名されたマクロのみを有効にする**（最も安全）

**Mac版 Excel の手順：**

1. **Excel** → **環境設定**
2. **セキュリティとプライバシー** → **マクロのセキュリティ**
3. マクロを有効化

### Step 2: 開発者タブを表示

VBA エディタを開くために、開発者タブを表示する必要があります。

**Windows版：**

1. **ファイル** → **オプション**
2. **リボンのユーザー設定**
3. **開発者** にチェック
4. **OK** をクリック

**Mac版：**

1. **ツール** → **マクロ** → **VB Editor を開く**（直接開く場合）

## マクロの作成方法

### 基本的な流れ

```
1. マクロの記録を開始
   ↓
2. Excel での操作を記録
   ↓
3. マクロの記録を停止
   ↓
4. 記録されたコードを確認・編集
   ↓
5. マクロを実行
```

### 方法1：マクロの記録（初心者向け）

マクロを記録する際は、**自動記録機能** を使用すると、操作が自動的に VBA コードに変換されます。

**操作手順：**

1. **開発者** タブをクリック
2. **マクロの記録** をクリック
3. **マクロ名** を入力（例：`DataFormatting`）
4. **保存場所** を選択（通常は「このブック」）
5. **OK** をクリック

```
マクロの記録開始後：
├─ セル入力
├─ データの選択
├─ 形式設定（色、フォント）
├─ 並べ替え
├─ オートフィルタ設定
└─ 保存
（すべての操作が記録される）
```

6. マクロ記録を終了する：**開発者** → **記録終了** をクリック

**実際の例：**

```
記録する操作の流れ：
1. A1 セルをクリック
2. 「データ」と入力して Enter
3. B1 セルをクリック
4. 「100」と入力して Enter
5. A1:B1 を選択
6. 塗りつぶし色を黄色に設定
7. 記録終了
```

記録されたコードは自動的に VBA で生成されます。

### 方法2：VBA エディタでコード記述（応用編）

より高度なマクロを作成する場合は、VBA エディタで直接コードを書きます。

**VB Editor を開く方法：**

1. **開発者** → **Visual Basic** をクリック
   または
2. **Alt + F11** キーを押す

**VB Editor の構成：**

```
左パネル：
├─ Project Explorer（ファイル構成）
│  └─ Sheet1, Sheet2 など

右パネル：
├─ Code Editor（コード記入欄）

下パネル：
└─ 出力ウィンドウ（実行結果表示）
```

## マクロの実行方法

### 方法1：開発者タブから実行

```
開発者 → マクロ → マクロ（Macro）を選択 → 実行
```

### 方法2：ショートカットキーで実行

マクロ作成時に **ショートカットキー**（例：Ctrl+Shift+M）を設定できます。

```
メリット：
└─ ワンキーでマクロを実行
```

### 方法3：ボタンから実行

ショートカットキーではなく、**ボタン** を配置してマクロを実行することもできます。

**手順：**

1. **挿入** → **図形** から四角形を選択
2. ワークシート上に図形を描画
3. 右クリック → **マクロの割り当て**
4. 実行したいマクロを選択して **OK**
5. 図形内に テキスト「実行」などを記入

**結果：** ボタンをクリックするとマクロが実行されます

## VBA の基本文法

マクロを自分で編集・作成するために、VBA の基本を理解します。

### セルに値を入力する

```vba
' A1 セルに「Hello」を入力
Range("A1").Value = "Hello"

' B2 セルに 100 を入力
Range("B2").Value = 100

' 複数セルに値を入力
Range("A1:A3").Value = "Data"
```

### セルを選択する

```vba
' A1 セルを選択
Range("A1").Select

' A1:C10 の範囲を選択
Range("A1:C10").Select

' A列全体を選択
Columns("A").Select
```

### セルをコピー・貼り付け

```vba
' A1 をコピー
Range("A1").Copy

' B1 に貼り付け
Range("B1").PasteSpecial

' 切り取り
Range("A1").Cut
```

### シートを切り替える

```vba
' Sheet2 をアクティブにする
Sheets("Sheet2").Activate

' 複数シートに値を入力
Sheets("Sheet1").Range("A1").Value = "Data1"
Sheets("Sheet2").Range("A1").Value = "Data2"
```

### ループ処理

```vba
' 1 から 10 まで繰り返し
Dim i As Integer
For i = 1 To 10
    Range("A" & i).Value = i
Next i
' 結果：A1に1、A2に2...A10に10
```

### 条件分岐

```vba
' B1 の値が 100 より大きい場合
If Range("B1").Value > 100 Then
    Range("C1").Value = "Large"
Else
    Range("C1").Value = "Small"
End If
```

### メッセージボックス（確認ダイアログ）

```vba
' ダイアログを表示
MsgBox "処理が完了しました"

' ユーザーの回答を受け取る
Dim answer As Integer
answer = MsgBox("続行しますか？", vbYesNo)
If answer = vbYes Then
    ' はいの場合の処理
End If
```

## 実践的な例

### 例1：複数シートへのデータ一括入力

```vba
Sub 複数シート一括入力()
    Dim i As Integer
    Dim sheetName As String
    
    ' Sheet1 から Sheet5 まで処理
    For i = 1 To 5
        sheetName = "Sheet" & i
        Sheets(sheetName).Range("A1").Value = "名前"
        Sheets(sheetName).Range("B1").Value = "データ"
        Sheets(sheetName).Range("A1:B1").Interior.Color = RGB(255, 255, 0) ' 黄色
    Next i
    
    MsgBox "5つのシートに見出しを入力しました"
End Sub
```

**実行結果：**
- Sheet1 から Sheet5 まで、A1 に「名前」、B1 に「データ」を入力
- 見出しが黄色に塗られます

### 例2：データの自動整形

```vba
Sub データ整形()
    Dim lastRow As Long
    Dim i As Long
    
    ' 最後のデータ行を取得
    lastRow = Cells(Rows.Count, 1).End(xlUp).Row
    
    ' 1行目は見出しなのでスキップ、2行目から処理
    For i = 2 To lastRow
        ' A列の数値をチェック
        If Cells(i, 1).Value < 50 Then
            Cells(i, 1).Interior.Color = RGB(255, 0, 0) ' 赤色
        ElseIf Cells(i, 1).Value < 80 Then
            Cells(i, 1).Interior.Color = RGB(255, 255, 0) ' 黄色
        Else
            Cells(i, 1).Interior.Color = RGB(0, 255, 0) ' 緑色
        End If
    Next i
End Sub
```

**実行結果：**
- A列のデータが色分けされます
- 50未満：赤、50～80：黄、80以上：緑

### 例3：レポート自動生成

```vba
Sub 月次レポート作成()
    Dim today As Date
    Dim month As String
    Dim year As String
    
    today = Date
    month = Month(today)
    year = Year(today)
    
    ' タイトルを作成
    Range("A1").Value = year & "年" & month & "月 月次レポート"
    Range("A1").Font.Size = 14
    Range("A1").Font.Bold = True
    
    ' サンプルデータを入力
    Range("A3").Value = "項目"
    Range("B3").Value = "売上"
    
    Range("A4").Value = "商品A"
    Range("B4").Value = "¥100,000"
    
    Range("A5").Value = "商品B"
    Range("B5").Value = "¥50,000"
    
    MsgBox "レポートを作成しました：" & year & "年" & month & "月"
End Sub
```

**実行結果：**
- 今月のレポートテンプレートが自動作成されます

## マクロのデバッグ（エラー対応）

### よくあるエラー

**エラー1：「オブジェクトが必要です」**
```vba
❌ Range.Value = "Data"  # Range が未指定
✅ Range("A1").Value = "Data"  # セルを指定
```

**エラー2：「型が一致しません」**
```vba
❌ Range("A1").Value = Range("B1:B5")  # 複数セルを1つに代入
✅ For Each cell In Range("B1:B5")
        Range("A" & cell).Value = cell.Value
   Next cell
```

**エラー3：「シートが見つかりません」**
```vba
❌ Sheets("Sheet1").Activate  # シート名が間違っている
✅ Sheets("実売上").Activate  # 正しいシート名を指定
```

### デバッグ機能

**ブレークポイントの設定：**

```
1. VB Editor でコードの左側をクリック
2. 赤い点が表示される（ここで一時停止）
3. F5 キーで実行すると、その行で停止
```

**ステップ実行：**

```
F8 キー：1行ずつ実行
F5 キー：次のブレークポイントまで実行
```

## ベストプラクティス

```
✅ 推奨される使い方

① 変数名は分かりやすく
   └─ BadName ❌ → goodVarName ✅

② コメントを記入
   └─ ' ここでデータを取得する

③ エラー処理を組み込む
   └─ On Error GoTo ErrorHandler

④ テストしてから本運用
   └─ テスト用シートで確認後に使用

⑤ 定期的にバックアップ
   └─ マクロ対応ファイルは重要

❌ 避けるべき方法

① すべてを Select で操作
   └─ 処理が遅くなる

② エラー処理なしで実行
   └─ 予期しない動作が発生

③ 不明な操作を記録
   └─ 無駄なコードが生成される

④ 他のマクロとの干渉
   └─ 変数名が重複しないようにする
```

## マクロの保存形式

Excel マクロを保存する場合は、**対応したファイル形式** を使用する必要があります。

### ファイル形式

| 形式 | 拡張子 | VBA対応 | 説明 |
|------|--------|--------|------|
| Excel ブック | .xlsx | ❌ | VBA 非対応（マクロは削除される） |
| Excel マクロ有効ブック | .xlsm | ✅ | VBA 対応（**推奨**） |
| Excel 97-2003 ブック | .xls | ✅ | 古い形式だが VBA 対応 |
| CSV | .csv | ❌ | テキスト形式（VBA 非対応） |

**保存方法：**

```
ファイル → 名前を付けて保存
→ ファイル形式を「Excel マクロ有効ブック（*.xlsm）」に変更
→ 保存
```

## セキュリティに関する注意

マクロは強力なツールですが、セキュリティ上の注意が必要です。

### 危険性

```
⚠️ マクロが実行できること

├─ ファイルの作成・削除
├─ フォルダへのアクセス
├─ 外部データベースへの接続
├─ ネットワークへの接続
└─ その他 Windows の操作
```

### セキュリティ対策

```
✅ マクロ使用時の安全対策

① 信頼できるソースからのみ
   └─ 不明なマクロは実行しない

② デジタル署名の確認
   └─ 発行者が認識可能なもの

③ 定期的なバックアップ
   └─ データ喪失に備える

④ ウイルス対策ソフトの更新
   └─ 常に最新状態に保つ
```

## トラブルシューティング

### マクロが実行されない場合

```
確認項目：
1. マクロが有効になっているか？
   → セキュリティ設定を確認

2. ファイル形式が正しいか？
   → .xlsm 形式で保存されているか

3. マクロが存在するか？
   → 開発者 → マクロで一覧確認

4. ショートカットキーが正しいか？
   → 別のアプリケーションと競合していないか
```

### マクロが遅い場合

```
改善方法：
1. Select の使用を避ける
   ❌ Range("A1").Select
      Selection.Value = "Data"
   
   ✅ Range("A1").Value = "Data"

2. ループ回数を減らす
   └─ 不要な繰り返しを削除

3. 画面更新を一時停止
   Application.ScreenUpdating = False
   ' 処理
   Application.ScreenUpdating = True
```

## 参考リソース

- [入門エクセルマクロの使い方｜マクロ作成から実行までを徹底解説](https://youtu.be/t4oaNtwwIqQ?si=LVjwgSlip3phamGe)
  - YouTube にて、マクロ作成から実行までの詳細解説

## 関連トピック

- [[VBA]]：Visual Basic for Applications 言語リファレンス
- [[Automation]]：自動化関連ツール
- [[Tools]]：ビジネスツール全般
