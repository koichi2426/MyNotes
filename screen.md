# screen: リモートセッション管理の強力なツール

## 概要

`screen`は、GNUプロジェクトの一環として開発されたターミナルマルチプレクサです。これにより、単一のターミナルセッション内で複数の仮想ターミナルを作成し、操作することが可能です。特に、SSHセッションからの切断後もプロセスを継続して実行できる点が特徴です。本記事では、`screen`の基本的な使い方や便利な機能について解説します。

### 主な特徴

- **セッション管理**: 複数の独立した仮想ターミナルを一つのセッション内で管理
- **切断と再接続**: SSHセッション切断後もプロセスが継続実行
- **ウィンドウ操作**: セッション内で複数のウィンドウを作成・切り替え可能
- **スクロールバック**: 過去の出力をスクロールして参照可能

## インストール

ほとんどのLinuxディストリビューションでは、`screen`は標準リポジトリからインストールできます。

```bash
sudo apt-get update
sudo apt-get install screen
```

## 基本的な使い方

### 新しいスクリーンセッションを開始

新しいスクリーンセッションを作成するには、以下のコマンドを使用します。セッションに名前を付けると管理が容易になります。

```bash
screen -S session_name
```

### スクリーンセッションをデタッチ

スクリーンセッションをデタッチするには、`Ctrl + A`を押してから`D`を押します。これにより、セッション内のプロセスがバックグラウンドで実行されたまま、画面から切り離されます。

```
Ctrl + A, D
```

### スクリーンセッションに再接続

既存のスクリーンセッションに再接続するには、以下のコマンドを使用します。

```bash
screen -r session_name
```

### すべてのスクリーンセッションを一覧表示

複数のスクリーンセッションが存在する場合、次のコマンドで一覧表示できます。

```bash
screen -ls
```

**出力例:**
```
There are screens on:
	1234.rails_server	(Detached)
	5678.work_session	(Attached)
2 Sockets in /run/screens/S-ubuntu.
```

## コマンド集

### 基本コマンド

#### 新しいスクリーンセッションを開始

```bash
screen -S session_name
```

**説明**: 新しいスクリーンセッションを開始し、セッションに名前を付ける。

#### スクリーンセッションをデタッチ

```
Ctrl + A, D
```

**説明**: 現在のスクリーンセッションをデタッチし、バックグラウンドで実行されるままにする。

**出力例:**
```
[detached from 1234.rails_server]
```

#### 既存のスクリーンセッションに再接続

```bash
screen -r session_name
```

**説明**: デタッチされたスクリーンセッションに再接続する。

#### スクリーンセッションの一覧表示

```bash
screen -ls
```

**説明**: 現在のスクリーンセッションの一覧を表示する。

### ウィンドウ操作

#### 新しいウィンドウを作成

```
Ctrl + A, C
```

**説明**: セッション内に新しいウィンドウを作成する。

#### ウィンドウ間を切り替え

```
Ctrl + A, n      # 次のウィンドウへ移動
Ctrl + A, p      # 前のウィンドウへ移動
Ctrl + A, <数字> # 指定した番号のウィンドウへ移動
```

**説明**: 複数のウィンドウ間を移動する。例えば2番目のウィンドウに移動するには`Ctrl + A`、次に`2`を押す。

#### ウィンドウの一覧表示

```
Ctrl + A, "
```

**説明**: 現在のセッション内のすべてのウィンドウを一覧表示し、選択して移動できる。

### セッション管理

#### 新しいセッションを開始（デフォルト）

```bash
screen
```

**説明**: デフォルトのセッションを開始する。セッション名は自動生成されます。

#### セッションの名前を変更

```
Ctrl + A, A
```

**説明**: 現在のウィンドウのタイトルを変更する。プロンプトが表示され、新しい名前を入力できます。

#### セッションをロック

```
Ctrl + A, x
```

**説明**: セッションをロックし、再度アクセスするにはパスワードが必要になります。

### スクロールとコピー

#### スクロールモードに入る

```
Ctrl + A, [
```

**説明**: スクロールバックモードに入り、矢印キーでスクロールできます。

#### スクロールモードを終了

```
Ctrl + G
```

**説明**: スクロールモードを終了してノーマルモードに戻ります。

#### テキストのコピー

1. **コピー開始ポイントを設定**: `Ctrl + A, [`でスクロールモードに入り、矢印キーで開始位置に移動して`Enter`を押す
2. **コピー終了ポイントを設定**: 終了位置に移動して再度`Enter`を押す

#### バッファからテキストを貼り付け

```
Ctrl + A, ]
```

**説明**: コピーしたテキストを現在のカーソル位置に貼り付ける。

### カスタマイズ

#### ~/.screenrcファイルの設定

`screen`の動作をカスタマイズするために、`~/.screenrc`ファイルを使用することができます。

```bash
# ~/.screenrc

# スタートアップメッセージを無効化
startup_message off

# スクロールバックバッファの行数を設定
defscrollback 10000

# カスタムキー割り当て
bindkey -k k1 select 0
bindkey -k k2 select 1
bindkey -k k3 select 2

# ウィンドウ名の自動更新
shelltitle "$ |bash"
```

**説明**: `~/.screenrc`ファイルにこれらの設定を記述することで、`screen`の動作をカスタマイズできます。

## 実用例：RailsサーバーをSSHセッションから切断しても動作させ続ける

`screen`を使ってRailsサーバーをSSHセッションから切断しても動作させ続ける手順を解説します。

### 手順

1. **新しいスクリーンセッションを開始**

```bash
screen -S rails_server
```

セッション名を`rails_server`として作成します。

2. **Railsサーバーを起動**

```bash
cd /home/ubuntu/url_performance_api
rails s -b 0.0.0.0 -p 3000
```

スクリーンセッション内でRailsサーバーを起動します。`-b 0.0.0.0`で全インターフェイスをバインド、`-p 3000`でポート3000を指定します。

3. **スクリーンセッションをデタッチ**

`Ctrl + A`を押してから`D`を押すと、スクリーンセッションをデタッチできます。

**出力:**
```
[detached from 1234.rails_server]
```

4. **SSHセッションを切断**

SSHセッションを切断しても、Railsサーバーは引き続き動作します。

5. **再接続後、スクリーンセッションに戻る**

再度SSHでサーバーに接続し、スクリーンセッションに戻るには、以下のコマンドを実行します。

```bash
screen -r rails_server
```

Railsサーバーはそのまま動作していることが確認できます。

### 複数のウィンドウでの運用例

```bash
# セッションの開始
screen -S development

# ウィンドウ1: Railsサーバー
rails s -b 0.0.0.0 -p 3000

# 新しいウィンドウを作成 (Ctrl + A, C)
# ウィンドウ2: ログの監視
tail -f log/development.log

# 新しいウィンドウを作成 (Ctrl + A, C)
# ウィンドウ3: その他の作業用シェル
# ここで他のコマンドを実行可能

# 各ウィンドウ間の切り替え: Ctrl + A, n / Ctrl + A, p / Ctrl + A, 0/1/2
```

## トラブルシューティング

### セッションが見つからない場合

`screen -r`コマンドでセッションが見つからない場合、次のコマンドで確認します。

```bash
screen -ls
```

表示されたセッションIDを使用して、再接続します。

```bash
screen -r session_id
```

### デタッチできない場合

`Ctrl + A`を押してから`D`を押してもデタッチできない場合、セッション内で`exit`コマンドを使用してセッションを終了します。

```bash
exit
```

### セッションをリセットしたい場合

セッションをリセットするには、セッション内で以下のコマンドを実行します。

```bash
Ctrl + A, :
reset
```

または、セッション外から:

```bash
screen -X -S session_name quit
```

## 主要なオプション一覧

| オプション | 説明 |
|-----------|------|
| `-S session_name` | 指定した名前でセッションを作成 |
| `-r session_name` | 既存のセッションに再接続 |
| `-ls` | すべてのセッション一覧を表示 |
| `-d session_name` | セッションをデタッチ（セッション外から実行） |
| `-X` | 指定したセッションにコマンドを送信 |
| `-c directory` | 指定したディレクトリでセッションを開始 |
| `-e` | エスケープシーケンスを指定 |
| `-p` | パスワード保護を有効化 |

## まとめ

`screen`は、リモートサーバー管理において非常に便利なツールです。SSHセッションを切断してもプロセスを継続して実行できるため、長時間実行するタスクやサーバーの管理に最適です。本記事で紹介した基本的な使い方と便利なコマンドを活用して、効率的なリモートセッション管理を行いましょう。
