# System Operations

システム運用の基本と戦略

## 概要

システム運用（System Operations）は、本番環境におけるシステムの安定性、セキュリティ、パフォーマンスを確保するための重要な活動です。単なるトラブルシューティングではなく、戦略的かつ継続的な改善プロセスです。

## 参考資料

### サイバーエージェント新卒研修資料
[2024年度 サイバーエージェント 新卒研修 - システム運用の基本と戦略](https://speakerdeck.com/mokopoi/2024nian-du-saibaeziento-xin-zu-yan-xiu-sisutemuyun-yong-noji-ben-tozhan-lue)

### IPA（情報処理推進機構）ガイドライン
- [IPA システム運用セキュリティガイドライン](https://www.ipa.go.jp/archive/publish/qv6pgp0000000yho-att/000005132.pdf)
- [IPA 情報セキュリティ対策ガイド](https://www.ipa.go.jp/archive/publish/qv6pgp0000000zlp-att/000005144.pdf)

## システム運用の基本

### 運用の三本柱

```
┌─────────────────────────────────────┐
│     システム運用の基本              │
├─────────────────────────────────────┤
│ 1. 監視・監視（Monitoring）         │
│    - リソース監視（CPU、メモリ）   │
│    - ログ監視・分析                │
│    - アラート設定                  │
│                                   │
│ 2. 保守・管理（Maintenance）        │
│    - パッチ適用・更新管理          │
│    - バックアップ・復旧            │
│    - ディスク容量管理              │
│                                   │
│ 3. セキュリティ（Security）         │
│    - アクセス制御                  │
│    - ネットワークセキュリティ      │
│    - 監査ログ管理                  │
└─────────────────────────────────────┘
```

### 運用の重要な特性

| 特性 | 説明 | 対策 |
|------|------|------|
| **24/7 稼働** | システムは常に稼働し続ける必要がある | シフト体制、自動化、アラート |
| **信頼性** | 予期しないダウンタイムを避ける | 冗長化、フェイルオーバー |
| **セキュリティ** | データ保護、不正アクセス防止 | アクセス制御、暗号化、監査 |
| **パフォーマンス** | ユーザーに快適な体験を提供 | リソース最適化、キャッシング |
| **コスト効率** | 効率的にシステムを運用 | 自動化、容量計画 |

## 運用プロセス

### 日次業務

```
朝礼
  ↓
前夜のログ確認
  ↓
アラート確認
  ↓
リソース状況確認
  ↓
定期バックアップ確認
  ↓
ユーザーからの報告対応
  ↓
夜勤への引き継ぎ
```

### 定期メンテナンス

```
週次（毎週金曜夜）
├─ ログローテーション
├─ ディスク容量確認
└─ セキュリティパッチ確認

月次（毎月第一日曜）
├─ フル バックアップテスト
├─ ドキュメント更新
├─ キャパシティプランニング
└─ セキュリティレビュー

年次
├─ ディザスタリカバリドリル
├─ セキュリティ監査
├─ インフラ更新計画立案
└─ ベンダーサポート更新
```

## 監視・モニタリング

### 何を監視すべきか

#### システムリソース

```
CPU（プロセッサ使用率）
├─ 閾値：70% 以上でアラート
├─ 100% 達成：パフォーマンス低下
└─ 対策：キャパシティ拡大 or 最適化

メモリ（RAM使用率）
├─ 閾値：85% 以上でアラート
├─ 100% 達成：スワップ発生→低速化
└─ 対策：メモリ増設、プロセス最適化

ディスク（ストレージ使用率）
├─ 閾値：80% 以上でアラート
├─ 100% 達成：ログ書き込み不可
└─ 対策：古いログ削除、ストレージ拡張

ネットワーク（通信速度）
├─ 閾値：帯域幅の80%
├─ 100% 達成：通信遅延・タイムアウト
└─ 対策：帯域幅拡張、通信最適化
```

#### アプリケーション監視

```
応答時間（Response Time）
├─ 目標：100ms 以下
├─ 警告：300ms 以上
└─ アラート：1秒以上

エラー率（Error Rate）
├─ 正常：0-1%
├─ 警告：1-5%
└─ アラート：5% 以上

リクエスト数（Throughput）
├─ トレンド監視
├─ ピークタイム識別
└─ スケーリング判定

可用性（Availability）
├─ 目標：99.9% 以上（ダウンタイム年間8時間以内）
├─ SLA定義で契約
└─ 定期レポート作成
```

### 監視ツール

| ツール | 用途 | 説明 |
|--------|------|------|
| **Prometheus** | メトリクス収集 | オープンソース時系列DB |
| **Grafana** | ダッシュボード作成 | 可視化、グラフ表示 |
| **ELK Stack** | ログ管理・分析 | Elasticsearch+Logstash+Kibana |
| **Datadog** | SaaS監視 | クラウドベース統合監視 |
| **New Relic** | APM | アプリケーション性能管理 |
| **CloudWatch** | AWS監視 | AWS専用モニタリング |

## ログ管理

### ログの役割

```
❶ トラブルシューティング
   - エラー原因の特定
   - 問題発生経路の追跡

❷ セキュリティ監視
   - 不正アクセス検出
   - 権限乱用の記録

❸ パフォーマンス分析
   - ボトルネック特定
   - リソース使用パターン分析

❹ コンプライアンス
   - 監査ログ保管
   - 法的要件への対応
```

### ログレベル

```
DEBUG（デバッグ）
├─ 最も詳細な情報
├─ 開発時のみ使用
└─ 本番環境では無効化

INFO（情報）
├─ 通常の運用情報
├─ アプリケーション起動・停止
└─ 重要なイベント

WARN（警告）
├─ 潜在的な問題
├─ 非推奨機能の使用
└─ リソース不足の兆候

ERROR（エラー）
├─ 動作失敗
├─ 例外発生
└─ 即座の対応が必要な場合あり

CRITICAL/FATAL（致命的）
├─ システム停止可能なエラー
├─ 即座の対応必須
└─ アラート発行
```

### ログローテーション

```
ログローテーションの必要性：

❌ ローテーションなし
  - ディスク満杯→ログ書き込み不可
  - ファイルサイズ大→読み込み遅い
  - 古いログが消えない→容量圧迫

✅ ローテーション実施
  - 定期的に古いログをアーカイブ
  - 圧縮して容量削減
  - 長期保管が可能

推奨設定：
- 日次ローテーション（毎日0時）
- 30日間保管
- gzip圧縮
- 保管場所：別ストレージ推奨
```

## セキュリティ運用

### アクセス制御

#### ユーザー管理

```
原則：最小権限の原則（Principle of Least Privilege）

✅ 推奨
├─ 必要な権限のみ付与
├─ 定期的に権限をレビュー
├─ 離職時の権限即刻削除
└─ 共有アカウント禁止

❌ 非推奨
├─ 全ユーザーに管理者権限
├─ 権限の定期的なレビューなし
├─ 共有パスワード使用
└─ 権限削除の遅延
```

#### パスワード管理

```
パスワードポリシー例：

長さ：12文字以上
複雑性：大文字、小文字、数字、特殊文字を含む
有効期限：90日（定期変更）
履歴：過去12個のパスワード再利用禁止
ロック機構：10回失敗で15分間ロック

セキュリティキー推奨：
└─ パスワードレス認証
   ├─ FIDO2
   ├─ U2F
   └─ 生体認証
```

### ネットワークセキュリティ

#### ファイアウォール設定

```
基本原則：ホワイトリスト方式

明示的に許可するポート：
├─ HTTP（80）
├─ HTTPS（443）
├─ SSH（22）- 特定IPのみ
└─ 必要なサービスのみ

その他すべてのポート：ブロック

定期レビュー：
├─ 月次でルール確認
├─ 不要なルール削除
└─ 新規要件への対応
```

#### ネットワークセグメンテーション

```
DMZ（Demilitarized Zone）
├─ 外部向けサービス配置
├─ Webサーバー、メールサーバー
└─ インターネットと内部ネットワーク間の緩衝地帯

内部ネットワーク
├─ 社内ユーザー、アプリケーションサーバー
└─ 厳格なアクセス制御

管理ネットワーク
├─ インフラ管理者用
├─ SSH、リモート管理
└─ 多要素認証必須
```

## バックアップ・災害復旧

### バックアップ戦略

#### 3-2-1 ルール

```
データを最低3つのコピーで保管
├─ オリジナルデータ：1つ
└─ バックアップ：2つ以上

異なる2種類のメディアに保管
├─ 例：HDD と クラウドストレージ
└─ 単一障害の影響を軽減

オフサイトに1つ保管
├─ 地理的に離れた場所
├─ 建物火災・災害対策
└─ クラウドバックアップ活用
```

#### バックアップの種類

| バックアップ種 | 対象 | 頻度 | 時間 | 用途 |
|---|---|---|---|---|
| **フル** | 全データ | 週1回 | 数時間 | 復旧の基準点 |
| **増分** | 前回以降の変更 | 日次 | 数分 | 日次の変更を記録 |
| **差分** | 前回フルバックアップ以降 | 日次 | 数十分 | 復旧時間短縮 |
| **スナップショット** | 仮想マシン/ボリュームの時点像 | 数時間ごと | 秒～分 | 迅速な復旧 |

### 災害復旧（DR）計画

#### RTO/RPO

```
RTO（Recovery Time Objective）：目標復旧時間
├─ システム停止を許容できる時間
├─ 短いほど高コスト
└─ 例：4時間以内に復旧

RPO（Recovery Point Objective）：目標復旧地点
├─ 許容できるデータ喪失量
├─ 短いほど高コスト
└─ 例：1時間以内のデータ復旧
```

#### DR レベル

```
Tier 0：バックアップなし
  - 復旧不可
  - リスク：最高

Tier 1：オフサイトバックアップのみ
  - 復旧時間：数日
  - コスト：低

Tier 2：ホットスタンバイ（異拠点レプリケーション）
  - 復旧時間：数時間
  - コスト：中

Tier 3：ホットスタンバイ + ロードバランシング
  - 復旧時間：数分
  - コスト：高

Tier 4：複数拠点の完全冗長化
  - 復旧時間：秒単位（自動フェイルオーバー）
  - コスト：最高
```

## パフォーマンス最適化

### キャパシティプランニング

```
ステップ：

① 現在の利用状況把握
   ├─ CPU、メモリ、ディスク、ネットワーク使用率
   ├─ ピークタイムの識別
   └─ トレンド分析（増加率の計算）

② 将来需要の予測
   ├─ 利用者増加
   ├─ データ量増加
   └─ 新機能追加の予定

③ 必要なリソース計算
   ├─ 現在値 × 成長率 = 必要なリソース
   └─ バッファ（例：30%）を加算

④ 調達計画
   ├─ 納期を考慮した予算申請
   └─ 段階的な投資計画
```

### チューニング項目

#### Webサーバー

```
Apache/NGINX：
├─ ワーカープロセス数最適化
├─ キープアライブ設定
├─ キャッシュヘッダ設定
└─ 圧縮（gzip）有効化

データベース：
├─ インデックス最適化
├─ クエリプランの確認
├─ 接続プール設定
└─ キャッシュレイヤー（Redis）導入
```

## 運用トラブルシューティング

### 一般的な問題と対応

| 問題 | 原因の可能性 | 対応手順 |
|------|------|------|
| **CPU 100%** | 無限ループ、メモリリーク、スパム | `top` で特定プロセス確認 → 停止 → ログ確認 |
| **メモリ不足** | メモリリーク、バッチ処理 | メモリプロファイリング → 再起動 or 増設 |
| **ディスク満杯** | ログ肥大化、キャッシュ蓄積 | 古いファイル削除 → ローテーション設定 |
| **応答遅い** | リソース不足、ネットワーク遅延 | `iostat`, `vmstat` で原因特定 |
| **接続エラー** | ファイアウォール、DNS問題 | `netstat`, `nslookup` で確認 |

### トラブルシューティングプロセス

```
1. 問題の報告受け取り
   - 症状、発生時刻、影響範囲を把握
   - ログレベルを上げる

2. 原因特定
   - システムリソース確認（top, free, df）
   - ネットワーク確認（netstat, ss）
   - ログ分析（tail, grep）

3. 一時対策
   - サービス再起動
   - リソース解放
   - アクセス制限

4. 根本原因分析
   - アプリケーションログ詳細確認
   - 設定ファイル確認
   - コード レビュー

5. 恒久対策実装
   - コード修正 or 設定変更
   - テスト環境で検証
   - 本番環境に反映

6. 再発防止策
   - 監視ルール追加
   - ドキュメント更新
   - 類似問題の予防
```

## 運用ベストプラクティス

### 変更管理

```
変更のリスク：
├─ 影響範囲が大きい
├─ 予期しない副作用発生の可能性
└─ ダウンタイムリスク

推奨プロセス：

1. 変更事前チェック
   └─ 影響範囲、リスク、ロールバック方法の確認

2. 変更ウィンドウ設定
   └─ ユーザー影響少ない時間（深夜、週末）

3. テスト環境での検証
   └─ ステージングで事前テスト

4. 段階的なロールアウト
   └─ カナリアリリース（一部ユーザーから開始）

5. 監視強化
   └─ リアルタイム監視、すぐロールバック可能に

6. ドキュメント更新
   └─ 変更内容、理由、結果を記録
```

### ドキュメンテーション

#### 運用マニュアル

```
重要な項目：

① 構成図
   ├─ ネットワーク構成
   ├─ サーバー配置
   └─ アプリケーション構成

② セットアップ手順
   ├─ 初期構築方法
   ├─ 必要なツールバージョン
   └─ 設定ファイル例

③ 日々の運用手順
   ├─ 起動・停止方法
   ├─ バックアップ手順
   └─ 定期メンテナンス

④ トラブルシューティング
   ├─ よくある問題と対応
   ├─ ログの見方
   └─ 連絡先

⑤ 緊急対応
   ├─ インシデント対応フロー
   ├─ エスカレーション
   └─ コミュニケーション方法
```

### 教育・スキル開発

```
新人研修内容：

座学（1-2週）
├─ システム構成・アーキテクチャ理解
├─ セキュリティ基本
└─ 監視ツール使い方

ハンズオン（2-4週）
├─ 簡単な変更（設定変更など）
├─ ログ分析実践
└─ 簡単なトラブルシューティング

OJT（1-3ヶ月）
├─ 経験者と一緒に運用
├─ 段階的に責任を増加
└─ インシデント対応実践

継続的学習
├─ 月次の技術勉強会
├─ ツールバージョンアップへの対応
└─ ベストプラクティスの共有
```

## 運用コスト削減

### 自動化による削減

```
手作業の課題：
├─ 時間がかかる
├─ ヒューマンエラー
├─ スケーラビリティなし

自動化の効果：

❌ 手動実行（1時間/日）
  └─ 年間：365時間 = 約45万円（時給1,200円の場合）

✅ スクリプト化（初期開発5時間）
  └─ 年間実行時間：0時間
  └─ 削減額：年間45万円

ROI = 45万円 / 開発コスト

スクリプト化対象：
├─ バックアップ
├─ ログローテーション
├─ リソース監視
├─ レポート生成
└─ ヘルスチェック
```

### クラウド活用

```
オンプレミスの課題：
├─ 初期投資が大きい
├─ 保守コスト（電気、冷却、管理者）
├─ 容量予測の難しさ
└─ スケーリングが困難

クラウアの利点：
├─ 従量課金（使用分だけ支払い）
├─ 保守コストなし
├─ 自動スケーリング
├─ 高可用性が標準
└─ グローバルリーチ

選択基準：
├─ 急成長企業 → クラウド
├─ 安定した処理量 → オンプレミス or ハイブリッド
└─ ピーク変動大 → クラウド（自動スケーリング）
```

## まとめ

システム運用の成功には以下が必要です：

```
✅ 適切な監視体制
   └─ リアルタイム監視、早期発見

✅ 定期的なメンテナンス
   └─ 予防保守で問題を事前に回避

✅ 強いセキュリティ
   └─ 多層防御、定期監査

✅ 自動化
   └─ コスト削減、品質向上

✅ チーム教育
   └─ スキル継承、ナレッジ蓄積

✅ ドキュメント管理
   └─ 属人性排除、迅速な対応

✅ 継続的改善
   └─ インシデント分析、プロセス改善
```

これらを組み合わせることで、安定性とセキュリティを備えた、費用対効果の高いシステム運用を実現できます。
